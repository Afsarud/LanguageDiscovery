@using System.Text.Json
@model BOCS.ModelsView.CourseInfoVM
@{
    ViewData["Title"] = "Course Info";

    var initialId = !string.IsNullOrWhiteSpace(Model.LatestYoutubeId)
        ? Model.LatestYoutubeId
        : (Model.Outlines.SelectMany(g => g.Items).FirstOrDefault()?.YoutubeId ?? "");

    // সার্ভার থেকে ফ্ল্যাট লিস্ট (indexing)
    var flatIds = Model.LessonIds ?? new List<string>();
    var idx = 0;
}

<section class="container py-4">
    <div class="mb-2 text-muted">Course info:</div>

    <!-- Info.cshtml -->
    <div id="videoShell" class="video-shell ratio ratio-16x9 mb-3">
        <div id="videoTop" class="video-frame"></div>

        <!-- (ঐচ্ছিক) ভিজ্যুয়াল মাস্ক: টপ লেফট/রাইটে টাইটেল/ওয়াটারমার্ক ঢাকতে -->
        <div class="video-mask tl" aria-hidden="true"></div>
        <div class="video-mask tr" aria-hidden="true"></div>

        <div class="guard guard-copy" aria-hidden="true"></div> <!-- Top-right: Copy link -->
        <div class="guard guard-more" aria-hidden="true"></div> <!-- Center-bottom: “More videos” ওভারলে -->
        <div class="guard guard-yt" aria-hidden="true"></div> <!-- Bottom-right: YouTube/Watch -->
        <div class="guard guard-gear" aria-hidden="true"></div> <!-- Bottom-right: Settings -->
        <div class="guard guard-cc" aria-hidden="true"></div> <!-- Bottom-right: CC -->
    </div>

    <!--all options blck-->
   @*  <div id="videoShell" class="video-shell ratio ratio-16x9 mb-3">
        <div id="videoTop" class="video-frame"></div>

        <!-- ভিজ্যুয়াল মাস্ক (শুধু ঢেকে রাখে) -->
        <div class="video-mask tl" aria-hidden="true"></div>
        <div class="video-mask tr" aria-hidden="true"></div>
        <div class="video-mask br" aria-hidden="true"></div>

        <!-- ক্লিক ব্লকার: Watch on YouTube ইত্যাদিতে ক্লিক যাবে না -->
        <div class="video-shield" aria-hidden="true"></div>
    </div> *@

    <div class="row g-3">
        <div class="col-lg-8">
            <h4 class="mb-2">@Model.Title</h4>
            <div class="text-muted">Course duration: @Model.DurationDays days</div>
            <div class="text-muted mb-3">Created by: @Model.CreatedBy</div>

            <h5 class="mt-3"><u>Course Outlines:</u></h5>

            <div class="accordion" id="outlineAcc">
                @for (var gIndex = 0; gIndex < Model.Outlines.Count; gIndex++)
                {
                    var g = Model.Outlines[gIndex];
                    var cid = $"collapse_{gIndex}";
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="heading_@gIndex">
                            <button class="accordion-button collapsed" type="button"
                                    data-bs-toggle="collapse" data-bs-target="#@cid"
                                    aria-expanded="false" aria-controls="@cid">
                                @g.Title
                            </button>
                        </h2>
                        <div id="@cid" class="accordion-collapse collapse" aria-labelledby="heading_@gIndex"
                             data-bs-parent="#outlineAcc">
                            <div class="accordion-body p-0">
                                <ul class="list-group list-group-flush">
                                    @foreach (var item in g.Items)
                                    {
                                        var isActive = item.YoutubeId == initialId;
                                        <li class="list-group-item d-flex justify-content-between align-items-center lesson-item @(isActive ? "active" : "")"
                                            data-idx="@idx" data-yt="@item.YoutubeId" role="button" tabindex="0">
                                            <span class="text-truncate">@item.Label</span>
                                            <i class="bi bi-play-circle"></i>
                                        </li>
                                        idx++;
                                    }
                                </ul>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>

        <div class="col-lg-4 ms-lg-auto text-end">
            <div class="mb-2">
                <span class="fw-semibold me-1">Duration:</span>
                @Model.DurationDays days
            </div>
            <div>
                <span class="fw-semibold me-1">Price:</span>
                ৳ @Model.PriceBdt.ToString("N0") BDT
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <script id="LESSON_IDS_DATA" type="application/json">
        @Html.Raw(System.Text.Json.JsonSerializer.Serialize(flatIds))
    </script>
    <script src="~/js/course-info.bootstrap.js" asp-append-version="true"></script>
    <!-- মূল লজিক: ক্লিক করলে প্লেয়ার বদলানো ইত্যাদি -->
    <script src="~/js/course-info.js" asp-append-version="true"></script>
}